version: "3.8"

services:
    # PostgreSQL Database
    db:
        image: postgres:15-alpine
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-movies_db}
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 5s
            retries: 5

    # Qdrant Vector Database
    qdrant:
        image: qdrant/qdrant:latest
        ports:
            - "6333:6333"
            - "6334:6334"
        volumes:
            - qdrant_data:/qdrant/storage
        environment:
            QDRANT__SERVICE__GRPC_PORT: 6334

    # TensorFlow Serving for User Tower
    tf-serving:
        image: tensorflow/serving:latest
        ports:
            - "8501:8501"
            - "8500:8500"
        volumes:
            - ../model/saved_models/user_tower:/models/user_tower/1
            - ./tf-serving/models.config:/models/models.config
        environment:
            MODEL_NAME: user_tower
        command: --model_config_file=/models/models.config --model_config_file_poll_wait_seconds=60

    # Django Backend
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "8000:8000"
        environment:
            - DEBUG=${DEBUG:-False}
            - SECRET_KEY=${SECRET_KEY:-django-insecure-change-me-in-production}
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-movies_db}
            - POSTGRES_DB=${POSTGRES_DB:-movies_db}
            - POSTGRES_USER=${POSTGRES_USER:-postgres}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
            - POSTGRES_HOST=db
            - POSTGRES_PORT=5432
            - QDRANT_HOST=qdrant
            - QDRANT_PORT=6333
            - TF_SERVING_HOST=tf-serving
            - TF_SERVING_PORT=8501
            - TMDB_API_KEY=${TMDB_API_KEY}
            - EMBEDDINGS_PATH=/data/embeddings
        volumes:
            - ./backend:/app
            - ../model/saved_models:/data/embeddings
            - ../model/data:/data/model_data
        depends_on:
            db:
                condition: service_healthy
            qdrant:
                condition: service_started
        command: >
            sh -c "python manage.py migrate &&
                   python manage.py runserver 0.0.0.0:8000"

    # Next.js Frontend
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        ports:
            - "3000:3000"
        environment:
            - NEXT_PUBLIC_API_URL=http://localhost:8000
            - NEXT_PUBLIC_TMDB_IMAGE_BASE=https://image.tmdb.org/t/p
        volumes:
            - ./frontend:/app
            - /app/node_modules
            - /app/.next
        depends_on:
            - backend
        command: npm run dev

volumes:
    postgres_data:
    qdrant_data:
